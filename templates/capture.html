<!doctype html>
<html lang="en">
    <head>
        <title>MyBudget - Receipt Capture</title>
        
        <!-- Required meta tags -->
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
        />

        <!-- Bootstrap CSS v5.2.1 -->
        <link href="../static/Bootstrap/bootstrap.css" rel="stylesheet"/>

        <!-- Custom CSS -->
        <link href="link to custom css" rel="stylesheet"/>

        <!-- JQuery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inria+Sans:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Noto+Sans+KR:wght@100..900&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Sofia+Sans+Condensed:ital,wght@0,1..1000;1,1..1000&family=Sofia+Sans:ital,wght@0,1..1000;1,1..1000&display=swap" rel="stylesheet">
    </head>

    <body>
        <header>
            <div class="container-fluid" style="background-color: #000000;">
                <div class="row m-0">
                    <div class="col">
                        <span class="fw-bold text-light">
                            <h1>MyBudget</h1>    
                        </span>
                    </div>
                    <div class="col text-end">
                        <span class="fw-bold">
                            <img src="/static/app logo short.png" class="img-fluid" alt="Black GBP Sign">
                        </span>
                    </div>
                </div>
            </div>
        </header>
            
        <main>
            <div class="container-xxl">
                <div class="row justify-content-center align-items-center my-3">
                    <div class="col text-center d-inline-block">
                        <h1>Capture and Upload Image</h1>
                    </div>
                </div>
                <div class="row justify-content-center align-items-center">
                    <div class="col text-center d-inline-block">
                        <div class="video-container">
                            <video id="video" autoplay playsinline></video>
                        </div>
                    </div>
                </div>
                <div class="row justify-content-center align-items-center my-2">
                    <div class="col text-center d-inline-block">
                            <div class="image-container">
                                <img class="d-none" id="capturedImage" alt="Captured Image">
                            </div>
                        </div>
                        <canvas class="d-none" id="canvas" ></canvas>
                    </div>
                </div>
                <div class="row justify-content-center align-items-center my-2">
                    <div class="col text-center d-inline-block">
                        <button id="captureBtn" class="btn btn-secondary">Capture Image</button>
                    </div>
                </div>
                <div class="row justify-content-center align-items-center">
                    <div class="col text-center d-inline-block">
                        <button id="submitBtn" class="btn btn-secondary d-none">Submit Image</button>
                    </div>
                </div>
            </div>
        </main>

        <nav class="navbar navbar-extend-md navbar-dark m-0 fixed-bottom" style="background-color: #000000;">
            <div class="container-fluid justify-content-center py-2" style="background-color: #000000;">
                <div class="col btn-group m-0">
                    <a href="/home" class="btn btn-secondary btn-outline-light btn-lg mx-0">Home</a>
                    <a href="/savings" class="btn btn-secondary btn-outline-light btn-lg mx-0">Savings</a>
                </div>
                <div class="col-12 col-md-1 text-center m-0">
                    <div class="btn-group dropup">
                        <button type="button" class="btn btn-secondary btn-outline-light btn-lg rounded-3 mx-0 my-2" data-bs-toggle="dropdown" aria-expanded="false">
                            +
                        </button>
                        <ul class="dropdown-menu">
                            <li><a href="/expenses" class="dropdown-item">Expenses</a></li>
                            <li><a href="/capture" class="dropdown-item">Receipt Capture</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col btn-group m-0">
                    <a href="/leaderboard" class="btn btn-secondary btn-outline-light btn-lg mx-0 ms-1">Leaderboard</a>
                    <a href="/profile" class="btn btn-secondary btn-outline-light btn-lg mx-0">Profile</a>
                </div>
            </div>
        </nav>
        
        <!-- Bootstrap JavaScript Libraries -->
        <script
            src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        ></script>
        <script
            src="../static/Bootstrap/bootstrap.js"
        ></script>

        <!-- Custom JavaScript -->
        <script>
            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const captureBtn = document.getElementById("captureBtn");
            const submitBtn = document.getElementById("submitBtn");
            const capturedImage = document.getElementById("capturedImage");

            let currentFacingMode = "environment"; // Default to back camera

            async function startCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: currentFacingMode }
                    });
                    video.srcObject = stream;
                } catch (error) {
                    alert(`Camera access error: ${error.name} - ${error.message}`);
                    console.error("Camera error:", error);
                }
            }

            captureBtn.addEventListener("click", () => {
                if (!video.srcObject) {
                    alert("Camera not started!");
                    return;
                }

                console.log("test");

                const context = canvas.getContext("2d");

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                capturedImage.src = canvas.toDataURL("image/png");
                capturedImage.style.display = "block";
                submitBtn.style.display = "block";
            });

            submitBtn.addEventListener("click", async () => {
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        alert("Error capturing image.");
                        return;
                    }

                    const formData = new FormData();
                    formData.append('image', blob, 'captured_image.png');

                    try {
                        const response = await fetch("/capture", { 
                            method: "POST",
                            body: formData,
                            headers: { "Accept": "application/json" }
                        });

                        const data = await response.json();
                        console.log("Server response:", data);

                        if (!response.ok) {
                            throw new Error(data.error || "Upload failed");
                        }

                        // Update the displayed image with the new one (force cache refresh)
                        capturedImage.src = data.image_url + "?t=" + new Date().getTime();
                        //capturedImage.style.display = "block"; //
                        capturedImage.remove("d-none").add("d-inline-block");
                        // alert("Image uploaded successfully!");
                        window.location.href = "/home";


                    } catch (error) {
                        console.error("Upload error:", error);
                        alert(`Error uploading image: ${error.message}`);
                    }
                }, 'image/png');
            });

            startCamera();
        </script>

        <script
            src="/static/app.js"
        ></script>
    </body>
</html>